# Docker Compose for Database Services Only (Development)
# This file runs MongoDB and MinIO for backend and frontend development
# The backend server and frontend UI should be run separately on host machine
# Usage: docker-compose -f docker-compose.dbonly.yml up -d
version: '3.8'

services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=travel_tracker
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - travel-tracker-network

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - travel-tracker-network

  minio-setup:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - travel-tracker-network
    environment:
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Waiting for MinIO to be ready..."
        until mc alias set myminio http://minio:9000 minioadmin minioadmin 2>/dev/null; do
          sleep 2
        done
        echo "MinIO is ready!"
        
        echo "Creating buckets..."
        mc mb myminio/gps-data --ignore-existing
        mc mb myminio/gps-analysis-data --ignore-existing
        mc mb myminio/images --ignore-existing
        mc mb myminio/gis-data --ignore-existing
        
        echo "Setting bucket policies..."
        mc anonymous set download myminio/gps-data
        mc anonymous set download myminio/gps-analysis-data
        mc anonymous set download myminio/images
        mc anonymous set download myminio/gis-data
        
        echo "âœ“ Bucket setup complete!"
        mc ls myminio/

volumes:
  mongodb_data:
    driver: local
    name: travel-tracker-mongo-data
  minio_data:
    driver: local
    name: travel-tracker-minio-data

networks:
  travel-tracker-network:
    driver: bridge